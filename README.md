# Bus Time Backend

Provides simple Flask-based web server for Bus Time updates backend.


## Running

You will need PostgreSQL 9.x, Sqlite 3.8.x, Python 2.7 and PIP installed.

1. Create empty PostgreSQL database for the Backend.
2. Create Backend configuration file based on `wsgi/backend.ini.template`.
3. Install required Python packages:

        $ pip install -r requirements.txt

4. Update database scheme:

        $ alembic -c ./wsgi/alembic.ini upgrade head

5. Optionally deploy latest Bus Time database:

        $ python ./wsgi/application --deploy-version

6. Run web server:

        $ python ./wsgi/application --run-server


## Deploying to OpenShift

You will need OpenShift account with a namespace created and OpenShift command-line tools set up to work with your account.

1. Create Python 2.7 application:

        $ rhc app create <app-name> python-2.7 -n <namespace> --repo .
OpenShift tools will complain they can not clone new application repo to current directory since there is another repo there, but this is OK.

2. Add PostgreSQL 9.2 cartridge to the application:

        $ rhc cartridge add postgresql-9.2 -a <app-name> -n <namespace>

3. Learn OpenShift git URL of the application by examining the output of the command:

        $ rhc app show <app-name> -n <namespace>

4. Add OpenShift git URL to the remotes:

        $ git remote add openshift <openshift-git-url>

5. Push repository data to OpenShift:

        $ git push openshift master:master --force
Option `--force` is needed to overwrite autogenerated commits in the remote repository. Normally no forced push will be needed in subsequent deployments.


### Notes

OpenShift seems to support `dependencies.txt` now, no `setup.py` is needed.

There is a [closed bug](https://bugzilla.redhat.com/show_bug.cgi?id=986219) about psycopg2 support. The “solution” recommended is to add `/opt/rh/postgresql92/root/usr/lib64/` to `LD_LIBRARY_PATH` whenever a psycopg2 module should be imported. This is worked around by a `deploy` and `pre_python_start` hooks in `.openshift/action_hooks`. However, deploying a Bus Time database via SSH will require manual running of the following command before deploying:

        source $OPENSHIFT_REPO_DIR/.openshift/action_hooks/util/add_pg_libs_to_library_path.sh
